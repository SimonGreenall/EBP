seajs.use(["post","js/ui/dialog","js/ui/confirm","panel"],function(a,e,n){var t,o,i=a.post;t={data:{},ev:{destory:function(){o.dlgPendding||o.isConfirming||(o.isUploaded?(n.show({msg:"头像正在上传中，确定放弃修改吗？",mask:!1,parent:o.$panel,onAccept:function(){o.isConfirming=!1,t.ev.clean()},onCancel:function(){o.isConfirming=!1}}),o.isConfirming=!0):t.ev.clean())},save:function(){return o.originImg?void(o.dlgPendding||o.isConfirming||(o.dlgPendding=e.show({type:"info",msg:"头像保存中，请稍候...",mask:!1,parent:o.$panel,buttons:[{text:"确定",type:"primary",click:function(){o.dlgPendding=null,this.remove()}}]}),$.ajax({type:"POST",url:"//myi.vip.com/api/image/save",data:{image_type:"AVATAR",x:cropPos.x>=0?cropPos.x:0,y:cropPos.y>=0?cropPos.y:0,width:cropPos.w,height:cropPos.h}}).done(function(a){a&&200===Number(a.code)?(o.isUploaded=!1,e.show({type:"success",msg:"上传成功，审核通过后会正常显示",mask:!1,parent:o.$panel,autoClose:3,buttons:[{text:"确定",type:"primary",click:function(){this.remove()}}],beforeClose:function(){return $(".hd-avatar img").attr("src",a.data),$(".J_avatar_fali_tip").removeClass("z-ui-tooltips-in"),!0},afterClose:function(){t.ev.clean()}})):e.show({type:"error",msg:"头像修改失败",mask:!1,parent:o.$panel,autoClose:3,buttons:[{text:"确定",type:"primary",click:function(){t.ev.clean(),this.remove()}}]})}).fail(function(){e.show({type:"error",msg:"头像修改失败",mask:!1,parent:o.$panel,autoClose:3,buttons:[{text:"确定",type:"primary",click:function(){this.remove()}}]})}).always(function(){o.dlgPendding&&(o.dlgPendding.remove(),o.dlgPendding=null)}))):void e.show({type:"info",msg:"请先上传头像...",mask:!1,parent:o.$panel,buttons:[{text:"确定",type:"primary",click:function(){this.remove()}}]})},clean:function(){cropPos=null,iframeWindow=null,$(".jcrop-holder").remove(),o.originImg=null,o.dlgPendding=null,o.isUploaded=!1,o.panel.hide(),window.navigator.__avatarUploadCallback=null},uploadCallback:function(a){o.isUploaded=!1,o.dlgPendding.remove(),o.dlgPendding=null;var n,i=JSON.parse(a);if(i&&200!=i.code)return n=500==i.code?"上传失败 请稍后重试":400==i.code?i.msg:i.msg.replace(/\+/g,""),void e.show({type:"error",msg:n,mask:!1,parent:o.$panel,buttons:[{text:"确定",type:"primary",click:function(){this.remove()}}]});var r=i.data.width,s=i.data.height,l=200,d=200,c=700;return 200>r||200>s?e.show({type:"error",msg:"图片最小高宽不能小于200",mask:!1,parent:o.$panel,buttons:[{text:"确定",type:"primary",click:function(){this.remove()}}]}):(o.isUploaded=!0,o.originImg=$("<img>").appendTo(o.$panel.find(".avatar-left").empty()).attr("src",i.data.url).error(function(){e.show({type:"error",msg:"图片加载失败，请重新上传",mask:!1,parent:o.$panel,autoClose:3,buttons:[{text:"确定",type:"primary",click:function(){this.remove()}}]}),o.isUploaded=!1}).Jcrop({aspectRatio:1,bgFade:!0,bgOpacity:.2,boxWidth:c,boxHeight:c,setSelect:[0,0,l,d],minSize:[200,200],onSelect:function(a){cropPos={x:parseInt(a.x)||0,y:parseInt(a.y)||0,x2:parseInt(a.x2)||0,y2:parseInt(a.y2)||0,w:parseInt(a.w)||0,h:parseInt(a.h)||0},t.ui.zoom(a)}},function(){var a=this,e=function(){o.$panel.find(".avatar-border").html('<img src="'+i.data.url+'">'),a.animateTo([(r-l)/2,(s-d)/2,(r+l)/2,(s+d)/2]),a.setSelect([(r-l)/2,(s-d)/2,(r+l)/2,(s+d)/2])};370>r||370>s?o.$panel.find(".jcrop-holder").animate({marginLeft:370>r?(370-r)/2:0,marginTop:(370>s?(370-s)/2:0)+5},200,function(){setTimeout(e,200)}):(o.$panel.find(".jcrop-holder").css({marginLeft:0,marginTop:5}),e())}),void(window.navigator.__avatarUploadCallback=null))},doUpload:function(){o.dlgPendding=e.show({type:"info",msg:"头像上传中，请稍候...",mask:!1,parent:o.$panel,buttons:[{text:"确定",type:"primary",click:function(){o.dlgPendding=null,this.remove()}}]}),window.navigator.__avatarUploadCallback=t.ev.uploadCallback,o.iframeWindow.document.getElementById("_avatarUploadForm_").submit()},handleUserIcon:function(){var a;return o.panel?(o.$panel.find(".avatar-border img").attr("src",$(".hd-avatar img").attr("src")).removeAttr("style"),o.panel.show()):void t.ui.getUserIconPanel(function(){a=$(o.iframeWindow.document.getElementById("_avatarUploadInputFile_")),a.change(function(){t.ev.doUpload()}),$("#userIcon-update").off("click").on("click",function(){a.click()}),o.$panel.find(".close , .ui-button[func='close']").off("click").on("click",function(){t.ev.destory()}),$("#userIcon-save").off("click").on("click",function(){t.ev.save()})})},initEvents:function(){$(".hd-avatar").on("click",function(){t.ev.handleUserIcon()}),-1!=navigator.userAgent.toLowerCase().indexOf("safari")&&"-1"==navigator.userAgent.toLowerCase().indexOf("chrome")&&$(".hd-avatar").addClass("safariHack")}},ui:{zoom:function(a){var e,n,t,i,r=o.originImg.width(),s=o.originImg.height();r>=s?(e=Math.floor(85/a.w*r),n=Math.floor(s/r*e)):(n=Math.floor(85/a.w*s),e=Math.floor(r/s*n)),t=Math.floor(e*a.x/r),i=Math.floor(n*a.y/s),o.$panel.find(".avatar-preview img").css({width:e,height:n,"margin-top":-i,"margin-left":-t})},getUserIconPanel:function(a){var e,n=new Panel("userIcon",'<div class="dlg-avatar">                                                        <h4 class="title">                                                            <i>自定义头像</i>                                                        </h4>                                                        <div class="btn-upload">                                                            <iframe src="avatar_upload_success.html" frameborder="0" name="avatar_upload_iframe"                                                                    id="avatar_upload_iframe"></iframe>                                                            <button role="button" class="ui-button" id="userIcon-update" mars_sead="103|2|3|2">上传头像</button>                                                            <span>支持大小不超过 5M 的 jpg、png 图片</span>                                                        </div>                                                        <div class="avatar-area clearfix">                                                            <div class="avatar-left"></div>                                                            <div class="avatar-right">                                                                <span>预览</span>                                                                <div class="avatar-preview">                                                                    <div class="avatar-border"><img src="'+$(".hd-avatar img").attr("src")+'"></div>                                                                </div>                                                            </div>                                                        </div>                                                        <p class="avatar-btns"><a class="ui-button secondary" id="userIcon-save" mars_sead="103|2|3|3">保存</a><a class="ui-button" func="close" mars_sead="103|2|3|4">取消</a></p>                                                    </div>',612,560);o.panel=n,n.show(),o.$panel=$("#userIcon"),e=document.getElementById("avatar_upload_iframe"),o.$panel.find(".close").attr("mars_sead","103|2|3|5"),$(e).load(function(){o.iframeWindow=document.getElementById("avatar_upload_iframe").contentWindow,a()})}},config:function(){o={panel:0,$panel:0,originImg:0,iframeWindow:0,dlgPendding:0,isUploaded:!1,isConfirming:!1},i.error(function(a){var e;a.code==a.code==200?0:a.code,302==a.code&&(e=encodeURIComponent(window.location.href),window.location.href=a.data.replace(/src=.*/,"")+e)})}},t.config(),t.ev.initEvents()});